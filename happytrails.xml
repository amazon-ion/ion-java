<?xml version="1.0"?>
<!--

  HappyTrails 2.0 Common Build File
  Last updated:  $DateTime: 2011/08/03 20:51:13 $

  ===========================================================================
  SUPPORT NOTE:
  ===========================================================================

  We are Happy to provide this file for YOUR convenience!
  However, as a condition of usage, you and your teammates
  are expected to know exactly how it works.

  Before using this file in your package build,
  please review this support policy document:

  https://spectre.amazon.com/?HappyTrails/Support_Policy

  For more information on Ant and HappyTrails refer to the following
  documents:

  Ant Home Page:          http://ant.apache.org/manual/
  HappyTrails Home Page:  https://spectre.amazon.com/?HappyTrails2
  HappyTrails FAQ:        https://spectre.amazon.com/?HappyTrails2/FAQ

  Thanks again for using HappyTrails 2.0!

  Sincerely,

    SPECTRE Team and the Amazon.com HappyTrails Developer Community

  ===========================================================================

  INSTALLATION:

  Copy this file into your package. Import it from your build.xml file. Enjoy!  :)


  CHANGE NOTICE:

  This file will change many times in the future.  It will never change in
  _your_ package until you want it to!  Please keep an eye on the HappyTrails
  home page so that you can pick up the latest and greatest changes!


  USAGE:

  You first must set a required environment variable that points to the 
  MiniTrails 2.0 library needed to initialize HappyTrails.

  export HT2_BOOTSTRAP_JAR=`/apollo/env/SDETools/bin/bootstrap-cache-package-version $WORKSPACE_ROOT MiniTrails 2.0`/lib/miniTrails-2.0.jar

  Next, you must import the happytrails.xml into your build.xml

  <project name="minimal">
 
    <import file="happytrails.xml" optional="false"/>

  </project>

  This is all it takes to get HappyTrails 2.0 initialized. As a result, you 
  will have all of the HappyTrails environment variables set up. 
  (See https://spectre.amazon.com/?HappyTrails2/BuildPropertiesGuide)

  Additionally,
   * You will have a "clean" target created 
   * You will have a property ${output.dir} set as an alias to 
     ${amazon.ht2.bd.thisPackage.build.dir}
   * You will have a property ${verbose} set to true if you are running
     under PackageBuilder. This can be passed to java, javac or other tasks
     to get better logs from PackageBuilder when something goes wrong and
     keep your desktop builds quiet

  ACKNOWLEDGEMENTS:

  This is adapted from Eric Crahen's TrailRunner examples. Thanks, Eric!


-->
<project
  xmlns:ht2b="antlib:amazon.ht2.mini.trails.ant"
  xmlns:ht2="antlib:amazon.ht2.trails.ant">

  <property environment="env" />
  <available property="htbootstrap.exists" file="${env.HT2_BOOTSTRAP_JAR}" />
  <fail unless="htbootstrap.exists"  message="HT2_BOOTSTRAP_JAR environment variable not defined or jar does not exist! (Check '${env.HT2_BOOTSTRAP_JAR}')" />


  <!-- MiniTrails 2.0 Bootstrap Task Definition (tasks with ht2b: prefix) -->
  <taskdef resource="amazon/ht2/mini/trails/ant/antlib.xml" onerror="fail"
    uri="antlib:amazon.ht2.mini.trails.ant" classpath="${env.HT2_BOOTSTRAP_JAR}" />


  <ht2b:bootpath packages="HappyTrails-2.0"/>
  <!-- 
  Use the following instead to use Codigo
  <ht2b:bootpath packages="HappyTrails-2.0, HappyTrailsCodigoPlugin-2.0" />
   -->


  <!-- HappyTrails 2.0 Task Definition (tasks with ht2: prefix) -->
  <taskdef resource="amazon/ht2/trails/ant/antlib.xml" onerror="fail"
    uri="antlib:amazon.ht2.trails.ant" classpath="${amazon.ht2.boot.path}" />


  <!--
     For more information about what this task does, see:

     https://spectre.amazon.com/?HappyTrails2/AntTaskGuide/HT2Configure
  -->
  <ht2:configure />


  <!--
    For more information about how these properties get set up, see:

     https://spectre.amazon.com/?HappyTrails2/BuildPropertiesGuide
  -->
  <mkdir dir="${amazon.ht2.bd.workspace.build.dir}" />
  <mkdir dir="${amazon.ht2.bd.thisPackage.build.dir}" />
  <mkdir dir="${amazon.ht2.bd.generated-ant.output.dir}" />
  <mkdir dir="${amazon.ht2.bd.private.output.dir}" />
  <mkdir dir="${amazon.ht2.bd.bin.output.dir}" />
  <mkdir dir="${amazon.ht2.bd.lib.output.dir}" />
  <mkdir dir="${amazon.ht2.bd.thisPackage.build.dir}/brazil-unit-tests" />

  <!--
    NOTE! interface.dep is required for PackageBuilder builds:
    please see http://devcentral.amazon.com/help/faq.cgi?cid=2#311
  -->
  <mkdir dir="${amazon.ht2.bd.interface.dep.output.dir}" />
  <touch file="${amazon.ht2.bd.interface.dep.output.dir}/interface.dep" />

  <!-- Only build the link on windows -->
  <condition property="amazon.ht2.require.symlink" value="false" else="true">
    <isset property="amazon.ht2.os.isWindows"/>
  </condition>
  <symlink action="single" overwrite="true" link="build" resource="${amazon.ht2.bd.thisPackage.build.dir}" failonerror="${amazon.ht2.require.symlink}"/>


  <target name="clean" description="removes package build directory">
    <symlink action="delete" overwrite="true" link="build" failonerror="${amazon.ht2.require.symlink}"/>
    <delete dir="${amazon.ht2.bd.thisPackage.build.dir}"/>
  </target>


  <!--
     For more information about what this task does, see:

     https://spectre.amazon.com/?HappyTrails2/AntTaskGuide/HT2Resolve
  -->
  <ht2:resolve />


  <!--
     For more information about what this task does, see:

     https://spectre.amazon.com/?HappyTrails2/AntTaskGuide/HT2Properties
  -->
  <ht2:properties />

  <!--
     For more information about what these tasks do, see:

     https://spectre.amazon.com/?HappyTrails2/AntTaskGuide/HT2Path
  -->
  <ht2:path dependencyType="run"   artifactType="jar"  property="run.classpath"   />
  <ht2:path dependencyType="build" artifactType="jar"  property="build.classpath" />
  <ht2:path dependencyType="test"  artifactType="jar"  property="test.classpath"  />

  <!-- HappyTrails 2.0 Brazil Unit Testing Task Definition -->
  <taskdef name="brazilunittest" classname="amazon.devtools.but.BrazilUnitTestTask" onerror="ignore">
    <classpath>
      <path path="${test.classpath}"/>
    </classpath>
  </taskdef>

  <!-- Create a simple alias for output -->
  <property name="output.dir" location="${amazon.ht2.bd.thisPackage.build.dir}" /> 

  <!-- Create an alias for the unit test directory -->
  <property name="unit.test.dir" location="${amazon.ht2.bd.thisPackage.build.dir}/brazil-unit-tests" /> 

  <!-- Detect PackageBuilder builds and set a flag to increase verbosity where appropriate -->
  <condition property="verbose" value="false" else="true">
    <or>
      <not><isset property="env.BRAZIL_VERSION"/></not>  <!-- When ant is run locally -->
      <equals arg1="${env.BRAZIL_VERSION}" arg2=""/>     <!-- When make is run locally -->
    </or>
  </condition>

</project>
